var wallboardUrl=$("#wallboard_url").val();var darkMode=$(".wallboard").hasClass("dark");var dateDisplay=document.getElementById("date");var timeDisplay=document.getElementById("hour");var $userTable=$(".user-table");var $recordTable=$(".record-table");var isPublic=false;var authUserDetails=null;var authPassword=undefined;var sipUsers={};var socket=undefined;var authToken=undefined;var idAwaiter={};var idAwaiterTimeouts={};var notificationSubscriber={};function getStatusIcon(userDetails){if(!userDetails.call_queue_available){return"icon-status-offline"}let icon;switch(userDetails.call_status){case"open":icon="icon-status-available";break;case"early":case"proceeding":icon="icon-status-ringing";break;case"confirmed":icon="icon-status-busy";break;case"closed":icon="icon-status-offline";break;default:icon="icon-status-offline"}return icon}function updateRowOrder(){var listitems=$userTable.children("li");var isLayout10=$("body").hasClass("layout-10");let sortedTable;if(isLayout10){sortedTable=listitems.sort(function(a,b){if(!a.dataset.name){return-1}else if(!b.dataset.name){return 1}else{return a.dataset.name.localeCompare(b.dataset.name)}})}else{var available=[];var unavailable=[];var busy=[];for(let i=0;i<listitems.length;i+=1){switch(listitems[i].dataset.status){case"ringing":case"available":available.push(listitems[i]);break;case"busy":busy.push(listitems[i]);break;case"offline":unavailable.push(listitems[i]);break}}function sortBySince(arr){return arr.sort((a,b)=>b.dataset.since-a.dataset.since).sort((a,b)=>a.dataset.since==="-1"||b.dataset.since==="-1"?1:-1)}sortedTable=jQuery([].concat(sortBySince(available),sortBySince(busy),sortBySince(unavailable)))}$userTable.append(sortedTable)}function deleteSingleRow(key){var row=$("#"+sipUsers[key].uuid);row.remove()}function updateSingleRow(key){var row=$("#"+sipUsers[key].uuid);if(row.length<1)return;var statusSpan=row.find("span.status");var statusIcon=$("<i>");statusIcon.attr("class",getStatusIcon(sipUsers[key]));statusSpan.html(statusIcon);var isLayout10=$("body").hasClass("layout-10");if(isLayout10){row.attr("data-name",sipUsers[key].name)}else{row.attr("data-status",getStatusIcon(sipUsers[key]).split("-").pop())}if(row.find(".interval")[0]&&!isLayout10){var timeValue;var time=row.find(".interval")[0].innerText;if(/\d/.test(time)){var timeArr=time.split(":");var hr=timeArr[0]*60*60;var min=timeArr[1]*60;var sec=timeArr[2];timeValue=hr+min+sec}else{timeValue=-1}row.attr("data-since",timeValue)}}function updateAllRows(){$(Object.keys(sipUsers)).each(function(index,key){var isLayout10=$("body").hasClass("layout-10");var isOffline=getStatusIcon(sipUsers[key]).includes("offline");switch(true){case sipUsers[key].last_call_end_yesterday&&isOffline&&!isLayout10:deleteSingleRow(key);break;default:updateSingleRow(key)}});updateRowOrder()}function setUserStatuses(data){$(data.result).each(function(index,user){var userName=user.sipuser.toLowerCase();if(!sipUsers.hasOwnProperty(userName))return;sipUsers[userName].call_status=user.status});updateAllRows()}function updateSingleUserStatus(user){var userName=user.sipuser.toLowerCase();if(!sipUsers.hasOwnProperty(userName))return;sipUsers[userName].call_status=user.status;updateSingleRow(userName)}function socketConnect(){socket=new WebSocket("wss://bifrost.yay.com/");socketListen()}function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))}function socketCall(method,params){return new Promise((resolve,reject)=>{if(!socket){reject(new Error("No Websocket"));return}if(socket.readyState!==WebSocket.OPEN){reject(new Error("Websocket Not Connected"));return}const data={};data.id=uuidv4();data.method=method;if(params)data.params=params;idAwaiterTimeouts[data.id]=setTimeout(()=>{delete idAwaiterTimeouts[data.id];reject(new Error("Timeout - Websocket Not Responding"))},1e4);idAwaiter[data.id]=responseData=>{clearTimeout(idAwaiterTimeouts[data.id]);delete idAwaiterTimeouts[data.id];delete idAwaiter[data.id];if(responseData.error?.message==="token expired"){reject(new Error("Token Expired"));return}if(responseData.error){reject(new Error(JSON.stringify(responseData)));return}resolve(responseData)};const json=JSON.stringify(data);try{socket?.send(json)}catch(error){clearTimeout(idAwaiterTimeouts[data.id]);reject(error)}})}function socketSubscribe(method,handlerFn){notificationSubscriber[method]=handlerFn}function socketPing(){if(socket?.readyState!==WebSocket.OPEN)return;socketCall("ping").then(()=>{setTimeout(()=>{socketPing()},1e4)}).catch(error=>{socket.close(4001,error.message)})}function generateAuthToken(userAuth){return new Promise((resolve,reject)=>{socketCall("authenticate",userAuth).then(({result:{token}})=>resolve({token:token})).catch(error=>reject(error))})}async function handleAuth({credentials,onAuth}){try{const{token}=await generateAuthToken(credentials);authToken=token;onAuth?.()}catch(error){setTimeout(()=>handleAuth({credentials:credentials,onAuth:onAuth}),1500)}}function socketListen(){switch(true){case!socket:case!authPassword:case!authUserDetails.username:return}socket.onopen=async()=>{await handleAuth({credentials:{username:authUserDetails.username,password:authPassword,user_status_only:true},onAuth:async()=>{setTimeout(()=>{socketPing()},1e4);try{var users=[];$(Object.keys(sipUsers)).each((index,key)=>{users.push(key)});const response=await socketCall("subscribe_user_status",{user:users.join(","),auth_token:authToken});setUserStatuses(response)}catch(error){}}})};socket.onerror=()=>{socket.close(4001,"websocket error")};socket.onclose=()=>{setTimeout(()=>{if(!socket)return;getStatus()},1500)};socket.onmessage=e=>{const data=JSON.parse(e.data.toString());if(data.id){idAwaiter[data.id]?.(data)}else{notificationSubscriber[data.method]?.(data)}}}function getStatus(){switch(socket?.readyState){case WebSocket.OPEN:case WebSocket.CONNECTING:case WebSocket.CLOSING:return}$.ajax({url:`/service/${window.wallboard&&window.wallboard.isPublic?"public/":""}voip/wallboard/${window.wallboard.uuid}/token`,method:"get",dataType:"json",contentType:"application/json"}).done(response=>{authPassword=response.result.auth_token;socketConnect();socketSubscribe("notify_user_status",data=>{updateSingleUserStatus(data.params)})})}function calcSla(answeredCalls,totalCalls){if([totalCalls,answeredCalls].includes(0)){return 0}const re=new RegExp("^-?\\d+(?:.\\d{0,"+2+"})?");if((answeredCalls/totalCalls).toString().match(re)){return Math.floor((answeredCalls/totalCalls).toString().match(re)[0]*100)}return 0}function updateHourlySla(wallboardUrl){$.ajax({url:"/svc/voip/wallboard/"+wallboardUrl+"?interval=hour",method:"get",dataType:"json",contentType:"application/json"}).done(function(R){$(".data.percentage-sla-hour").text(calcSla(R["stats"]["num_answered_within"],R["stats"]["num_calls"])+"%")}).always(function(){setTimeout(function(){updateHourlySla(wallboardUrl)},6e4)})}function lastCallEndYesterday(secSinceLastCallEnd){if(!secSinceLastCallEnd){return true}var d=new Date,e=new Date(d);var msSinceMidnight=e-d.setHours(0,0,0,0);return secSinceLastCallEnd>msSinceMidnight/1e3}function updateStats(wallboardUrl){$.ajax({url:"/svc/voip/wallboard/"+wallboardUrl,method:"get",dataType:"json",contentType:"application/json"}).done(function(R){dateDisplay.innerHTML=R["date"];timeDisplay.innerHTML=R["time"];$(R["user_stats"]).each(function(index,user){var userName=user.user_name.toLowerCase();if(!authUserDetails){authUserDetails={username:userName}}if(sipUsers[userName]){sipUsers[userName].call_queue_available=user.status!=="unavailable";sipUsers[userName].last_call_end_yesterday=lastCallEndYesterday(user.since_last_end)}else{sipUsers[userName]={call_queue_available:user.status!=="unavailable",call_status:"closed",uuid:user.user_uuid,name:user.name||"unknown",last_call_end_yesterday:lastCallEndYesterday(user.since_last_end)}}});$(".data.in_queue").text(R["in_queue"]);$(".data.users_available").text(R["stats"]["users_available"]);$(".data.users_unavailable").text(R["stats"]["users_unavailable"]);if($("body").hasClass("layout-9")){$(".data.percentage-sla").text(calcSla(R["stats"]["num_answered_within"],R["stats"]["num_calls"])+"%")}$(".data.num_calls").text(R["stats"]["num_calls"]);$(".data.num_abandoned").text(R["stats"]["num_abandoned"]);$(".data.num_answered").text(R["stats"]["num_answered"]);$(".data.num_timeout").text(R["stats"]["num_timeout"]);$(".data.num_noregistered").text(R["stats"]["num_noregistered"]);$(".data.num_shortcode").text(R["stats"]["num_shortcode"]);$(".data.total_duration").text(R["stats"]["total_duration"]);$(".data.total_wait_duration").text(R["stats"]["total_wait_duration"]);$(".data.total_ring_duration").text(R["stats"]["total_ring_duration"]);$(".data.total_call_duration").text(R["stats"]["total_call_duration"]);$(".data.average_duration").text(R["stats"]["average_duration"]);$(".data.average_wait_duration").text(R["stats"]["average_wait_duration"]);$(".data.average_ring_duration").text(R["stats"]["average_ring_duration"]);$(".data.average_call_duration").text(R["stats"]["average_call_duration"]);$(".data.max_duration").text(R["stats"]["max_duration"]);$(".data.max_wait_duration").text(R["stats"]["max_wait_duration"]);$(".data.max_ring_duration").text(R["stats"]["max_ring_duration"]);$(".data.max_call_duration").text(R["stats"]["max_call_duration"]);$(".data.prev_num_calls").text(R["compare_stats"]["num_calls"]);$(".data.prev_num_abandoned").text(R["compare_stats"]["num_abandoned"]);$(".data.prev_num_answered").text(R["compare_stats"]["num_answered"]);$(".data.prev_num_timeout").text(R["compare_stats"]["num_timeout"]);$(".data.prev_num_noregistered").text(R["compare_stats"]["num_noregistered"]);$(".data.prev_num_shortcode").text(R["compare_stats"]["num_shortcode"]);$(".data.prev_total_duration").text(R["compare_stats"]["total_duration"]);$(".data.prev_total_wait_duration").text(R["compare_stats"]["total_wait_duration"]);$(".data.prev_total_ring_duration").text(R["compare_stats"]["total_ring_duration"]);$(".data.prev_total_call_duration").text(R["compare_stats"]["total_call_duration"]);$(".data.prev_average_duration").text(R["compare_stats"]["average_duration"]);$(".data.prev_average_wait_duration").text(R["compare_stats"]["average_wait_duration"]);$(".data.prev_average_ring_duration").text(R["compare_stats"]["average_ring_duration"]);$(".data.prev_average_call_duration").text(R["compare_stats"]["average_call_duration"]);$(".data.prev_max_duration").text(R["compare_stats"]["max_duration"]);$(".data.prev_max_wait_duration").text(R["compare_stats"]["max_wait_duration"]);$(".data.prev_max_ring_duration").text(R["compare_stats"]["max_ring_duration"]);$(".data.prev_max_call_duration").text(R["compare_stats"]["max_call_duration"]);$userTable.each(function(){$(this).children("li[class!=table-header]").remove();$(this).append(R["user_html"])});$recordTable.each(function(){$(this).children("li[class!=table-header]").remove();$(this).append(R["records_html"])});getStatus();updateAllRows()}).always(function(){setTimeout(function(){updateStats(wallboardUrl)},2500)})}function makeSquare(){$(".square").each(function(){this.style.height=this.offsetWidth})}$(function(){makeSquare();window.addEventListener("resize",function(){makeSquare()});updateStats(wallboardUrl);if($("body").hasClass("layout-9")){updateHourlySla(wallboardUrl)}if(document.getElementById("chart_calls")!=null){google.charts.load("current",{packages:["corechart"]});google.charts.setOnLoadCallback(function(){pollChartData(wallboardUrl)})}});function pollChartData(wallboardUrl){$.ajax({url:"/svc/voip/wallboard/"+wallboardUrl+"/chart",method:"get",dataType:"json",contentType:"application/json"}).done(function(result){if(result["result"]){$(".chart_report_period").text(result["report_period"]);$(".chart_total_calls").text(result["total_calls"]);$(".chart_total_calls").attr("data-font-medium",result["total_calls"]>=1e4);$(".chart_total_calls").attr("data-font-small",result["total_calls"]>=1e5);updateChart(result["data"])}}).always(function(){setTimeout(function(){pollChartData(wallboardUrl)},3e4)})}var chartData;var chartOptions;function updateChart(data){chartData=new google.visualization.DataTable(data);chartOptions={colors:["#ff7461"],curveType:"function",legend:{position:"none"},backgroundColor:darkMode?"#534742":"#ffffff",hAxis:{title:"Time",baselineColor:darkMode?"#000000":"#f3e6e3",titleTextStyle:{color:darkMode?"#ffffff":"#88807d",fontName:"Avenir"},textStyle:{color:darkMode?"#ffffff":"#332925",fontName:"Avenir",fontSize:12},gridlines:{color:darkMode?"#000000":"#f3e6e3"}},vAxis:{title:"Calls",baselineColor:darkMode?"#000000":"#f3e6e3",titleTextStyle:{color:darkMode?"#ffffff":"#88807d",fontName:"Avenir",fontSize:"8px"},textStyle:{color:darkMode?"#ffffff":"#332925",fontName:"Avenir",fontSize:12},gridlines:{color:darkMode?"#000000":"#f3e6e3"}},pointSize:5,pointShape:{type:"diamond"}};drawChart();window.addEventListener("resize",drawChart)}function drawChart(){$("#chart_calls").empty();var callsChart=new google.visualization.AreaChart(document.getElementById("chart_calls"));callsChart.draw(chartData,chartOptions)}